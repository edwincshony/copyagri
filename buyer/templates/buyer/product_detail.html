{% extends 'accounts/base.html' %}
{% block title %}{{ listing.name }} - Product Detail{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        {% if listing.image %}
            <img src="{{ listing.image.url }}" class="img-fluid rounded" alt="{{ listing.name }}">
        {% else %}
            <img src="https://via.placeholder.com/600x400?text=No+Image" class="img-fluid rounded" alt="No image">
        {% endif %}
    </div>
    <div class="col-md-6">
        <h2>{{ listing.name }}</h2>
        <p><strong>Crop Type:</strong> {{ listing.crop_type }}</p>
        <p><strong>Location:</strong> {{ listing.location }}</p>
        <p><strong>Base Price:</strong> â‚¹{{ listing.price }}</p>
        <p><strong>Total Stock:</strong> {{ listing.available_quantity }}</p>
        <p><strong>Available for Direct Purchase:</strong> {{ listing.available_quantity }}</p>
        
        {% if listing.description %}
            <p><strong>Description:</strong> {{ listing.description }}</p>
        {% endif %}
        
        <!-- Bidding Status -->
        {% if listing.is_bidding_open %}
            <div class="alert alert-info">
                <strong>Bidding is OPEN!</strong><br>
                Ends: {{ listing.bid_end_time|date:"d M Y H:i" }}
            </div>
        {% elif listing.has_bidding_ended %}
            <div class="alert alert-warning">
                <strong>Bidding has ENDED</strong><br>
                Ended: {{ listing.bid_end_time|date:"d M Y H:i" }}
            </div>
        {% endif %}
        
        <!-- Winner Payment CTA -->
        {% if show_winner_pay_cta %}
            <div class="alert alert-success">
                <h5>ðŸŽ‰ You Won the Bid!</h5>
                <p><strong>Winning Price:</strong> â‚¹{{ winner_bid.amount }} Ã— {{ winner_bid.quantity }} = â‚¹{{ winner_bid.total_amount }}</p>
                <p><strong>Payment Deadline:</strong> {{ listing.payment_deadline|date:"d M Y H:i" }}</p>
                <a href="?init_bid_payment=1" class="btn btn-success btn-lg">Pay Now</a>
            </div>
        {% elif is_winner and winner_bid.payment_status == 'completed' %}
            <div class="alert alert-success">
                <strong>âœ“ Payment Completed</strong><br>
                You have successfully purchased this item through bidding.
            </div>
        {% endif %}
        
        <!-- Place Bid Form -->
        {% if listing.is_bidding_open and not is_winner %}
            <div class="card mb-3">
                <div class="card-body">
                    <h5>Place Your Bid</h5>
                    <form method="post" action="{% url 'buyer:place_bid' listing.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label>Bid Amount (â‚¹)</label>
                            <input type="number" name="amount" class="form-control" min="{{ listing.price }}" step="0.01" required>
                            <small class="text-muted">Minimum: â‚¹{{ listing.price }}</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Place Bid</button>
                    </form>
                </div>
            </div>
        {% endif %}
        
        <!-- Regular Purchase Form -->
        {% if available_for_purchase and purchase_form %}
            <div class="card">
                <div class="card-body">
                    <h5>Direct Purchase</h5>
                    <form method="post">
                        {% csrf_token %}
                        {{ purchase_form.as_p }}
                        <button type="submit" name="purchase_submit" class="btn btn-success">Buy Now</button>
                    </form>
                </div>
            </div>
        {% elif not available_for_purchase %}
            <div class="alert alert-secondary">
                Direct purchase is currently unavailable (stock locked or sold out).
            </div>
        {% endif %}
    </div>
</div>

<!-- Bid History -->
<div class="row mt-4">
    <div class="col-12">
        <h4>Bid History</h4>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Bidder</th>
                    <th>Amount</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th>Time</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for bid in bids %}
                <tr>
                    <td>{{ bid.bidder.username }}</td>
                    <td>â‚¹{{ bid.amount }}</td>
                    <td>{{ bid.quantity }}</td>
                    <td>â‚¹{{ bid.total_amount }}</td>
                    <td>{{ bid.placed_at|date:"d M Y H:i" }}</td>
                    <td>
                        {% if bid.payment_status == 'completed' %}
                            <span class="badge bg-success">Paid</span>
                        {% elif bid == winner_bid %}
                            <span class="badge bg-warning text-dark">Winner - Pending Payment</span>
                        {% else %}
                            <span class="badge bg-secondary">Outbid</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center text-muted">No bids yet</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<a href="{% url 'buyer:marketplace_buy' %}" class="btn btn-secondary mt-3">Back to Marketplace</a>
{% endblock %}
