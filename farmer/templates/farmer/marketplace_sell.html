{% extends 'accounts/base.html' %}
{% block title %}Marketplace - Sell - AgriLeader{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">My Product Listings</h2>
  <a href="{% url 'farmer:create_listing' %}" class="btn btn-primary">+ Create New Listing</a>
</div>

<!-- Revenue Summary -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card bg-light">
      <div class="card-body">
        <h5 class="card-title">Completed Sales Revenue</h5>
        <h3 class="text-success">₹{{ total_revenue|floatformat:2 }}</h3>
        <div class="small text-muted">
          <div>Completed Bids: ₹{{ total_bid_revenue|floatformat:2 }}</div>
          <div>Completed Direct Sales: ₹{{ total_regular_revenue|floatformat:2 }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card bg-light">
      <div class="card-body">
        <h5 class="card-title">Pending Payments</h5>
        <h3 class="text-warning">₹{{ total_pending_revenue|floatformat:2 }}</h3>
        <div class="small text-muted">
          <div>Awaiting winner or buyer completion</div>
        </div>
      </div>
    </div>
  </div>
</div>

<ul class="nav nav-tabs" id="listingTabs" role="tablist">
  <li class="nav-item">
    <button class="nav-link active" id="ongoing-tab" data-bs-toggle="tab" data-bs-target="#ongoing" type="button">Active Bidding</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" id="awaiting-tab" data-bs-toggle="tab" data-bs-target="#awaiting" type="button">Awaiting Winner Payment (6h)</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past" type="button">Past</button>
  </li>
</ul>

<div class="tab-content mt-3">
  <!-- Active Bidding -->
  <div class="tab-pane fade show active" id="ongoing">
    <div class="row">
      {% for listing in ongoing_listings %}
      <div class="col-md-4 mb-4">
        <div class="card h-100">
          {% if listing.image %}
            <img src="{{ listing.image.url }}" class="card-img-top" alt="{{ listing.name }}" style="height: 200px; object-fit: cover;">
          {% else %}
            <img src="https://via.placeholder.com/480x200?text=No+Image" class="card-img-top" alt="No image" style="height: 200px; object-fit: cover;">
          {% endif %}
          <div class="card-body">
            <h5 class="card-title d-flex justify-content-between align-items-center">
              <span>{{ listing.name }}</span>
              <span class="badge bg-success">Bidding Open</span>
            </h5>
            <p class="card-text">
              <strong>Crop Type:</strong> {{ listing.crop_type }}<br>
              <strong>Total Stock:</strong> {{ listing.quantity }}<br>
              <strong>Base Price:</strong> ₹{{ listing.price }}<br>
              <strong>Location:</strong> {{ listing.location }}<br>
              {% if listing.description %}<strong>Description:</strong> {{ listing.description|truncatewords:20 }}<br>{% endif %}
              <strong>Ends:</strong> {{ listing.bid_end_time|date:"d M Y H:i" }}<br>
            </p>

            <div class="border-top pt-2 mt-2">
              <h6>Inventory & Revenue</h6>
              <div class="small">
                <div>Available Quantity: {{ listing.available_quantity }}</div>
                <div class="mt-2">
                  <strong>Completed Payments:</strong>
                  <div>Bid Revenue: ₹{{ listing.bid_revenue|floatformat:2 }}</div>
                  <div>Direct Sales: ₹{{ listing.regular_sales_revenue|floatformat:2 }}</div>
                  <div class="fw-bold">Total Revenue: ₹{{ listing.total_revenue|floatformat:2 }}</div>
                </div>
                {% if listing.pending_revenue > 0 %}
                <div class="mt-2">
                  <strong class="text-warning">Pending Payments:</strong>
                  <div>₹{{ listing.pending_revenue|floatformat:2 }}</div>
                </div>
                {% endif %}
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <a href="{% url 'farmer:edit_listing' listing.id %}" class="btn btn-sm btn-warning">Edit</a>
              <a href="{% url 'farmer:delete_listing' listing.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this listing?')">Delete</a>
            </div>
          </div>
        </div>
      </div>
      {% empty %}
        <div class="col-12"><p class="text-muted">No active bidding listings.</p></div>
      {% endfor %}
    </div>

    {% if ongoing_page_obj %}
      {% include 'partials/pagination.html' with page_obj=ongoing_page_obj %}
    {% endif %}
  </div>

  <!-- Awaiting Winner Payment (6h) -->
  <div class="tab-pane fade" id="awaiting">
    <div class="row">
      {% for listing in awaiting_payment_listings %}
      <div class="col-md-4 mb-4">
        <div class="card h-100">
          {% if listing.image %}
            <img src="{{ listing.image.url }}" class="card-img-top" alt="{{ listing.name }}" style="height: 200px; object-fit: cover;">
          {% else %}
            <img src="https://via.placeholder.com/480x200?text=No+Image" class="card-img-top" alt="No image" style="height: 200px; object-fit: cover;">
          {% endif %}
          <div class="card-body">
            <h5 class="card-title d-flex justify-content-between align-items-center">
              <span>{{ listing.name }}</span>
              <span class="badge bg-warning text-dark">Awaiting Payment</span>
            </h5>
            <p class="card-text mb-2">
              <strong>Auction Ended:</strong> {{ listing.bid_end_time|date:"d M Y H:i" }}<br>
              <strong>Payment Deadline:</strong> {{ listing.payment_deadline|date:"d M Y H:i" }}<br>
            </p>

            {% with wb=listing.winning_bid %}
              {% if wb %}
                <div class="mb-2">
                  <strong>Winner:</strong> {{ wb.bidder.username }}<br>
                  <strong>Winning Price:</strong> ₹{{ wb.amount }} × {{ wb.quantity }}<br>
                  {% if wb.payment_status == 'pending' %}
                    <span class="badge bg-warning text-dark">Payment Pending</span>
                  {% elif wb.payment_status == 'completed' %}
                    <span class="badge bg-success">Payment Completed</span>
                  {% endif %}
                </div>
              {% else %}
                <div class="text-muted">No valid winner within window.</div>
              {% endif %}
            {% endwith %}

            <div class="border-top pt-2 mt-2">
              <h6>Revenue Snapshot</h6>
              <div class="small">
                <div>Bid Revenue: ₹{{ listing.bid_revenue|floatformat:2 }}</div>
                <div>Direct Sales: ₹{{ listing.regular_sales_revenue|floatformat:2 }}</div>
                <div class="fw-bold">Total Revenue: ₹{{ listing.total_revenue|floatformat:2 }}</div>
                {% if listing.pending_revenue > 0 %}
                  <div class="mt-1 text-warning">Pending: ₹{{ listing.pending_revenue|floatformat:2 }}</div>
                {% endif %}
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <a href="{% url 'farmer:edit_listing' listing.id %}" class="btn btn-sm btn-warning">Edit</a>
              <a href="{% url 'farmer:delete_listing' listing.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this listing?')">Delete</a>
              <a href="{% url 'buyer:product_detail' listing.id %}" class="btn btn-sm btn-outline-primary">View</a>
            </div>
          </div>
        </div>
      </div>
      {% empty %}
        <div class="col-12"><p class="text-muted">No listings awaiting winner payment.</p></div>
      {% endfor %}
    </div>

    {% if awaiting_page_obj %}
      {% include 'partials/pagination.html' with page_obj=awaiting_page_obj %}
    {% endif %}
  </div>

  <!-- Past Listings -->
  <div class="tab-pane fade" id="past">
    <div class="row">
      {% for listing in past_listings %}
      <div class="col-md-4 mb-4">
        <div class="card h-100">
          {% if listing.image %}
            <img src="{{ listing.image.url }}" class="card-img-top" alt="{{ listing.name }}" style="height: 200px; object-fit: cover;">
          {% else %}
            <img src="https://via.placeholder.com/480x200?text=No+Image" class="card-img-top" alt="No image" style="height: 200px; object-fit: cover;">
          {% endif %}
          <div class="card-body">
            <h5 class="card-title d-flex justify-content-between align-items-center">
              <span>{{ listing.name }}</span>
              <span class="badge bg-secondary">Past</span>
            </h5>
            <p class="card-text">
              <strong>Crop Type:</strong> {{ listing.crop_type }}<br>
              <strong>Total Stock:</strong> {{ listing.quantity }}<br>
              <strong>Base Price:</strong> ₹{{ listing.price }}<br>
              <strong>Location:</strong> {{ listing.location }}<br>
              {% if listing.description %}<strong>Description:</strong> {{ listing.description|truncatewords:20 }}<br>{% endif %}
              {% with bid=listing.winning_bid %}
                {% if bid %}
                  <strong>Winner:</strong> {{ bid.bidder.username }}<br>
                  <strong>Winning Price:</strong> ₹{{ bid.amount }} × {{ bid.quantity }}<br>
                {% else %}
                  <strong>No bids received</strong><br>
                {% endif %}
              {% endwith %}
            </p>

            <div class="border-top pt-2 mt-2">
              <h6>Final Revenue Summary</h6>
              <div class="small">
                <div>Bid Revenue: ₹{{ listing.bid_revenue|floatformat:2 }}</div>
                <div>Direct Sales: ₹{{ listing.regular_sales_revenue|floatformat:2 }}</div>
                <div class="fw-bold mt-1">Total: ₹{{ listing.total_revenue|floatformat:2 }}</div>
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <a href="{% url 'farmer:edit_listing' listing.id %}" class="btn btn-sm btn-warning">Edit</a>
              <a href="{% url 'farmer:delete_listing' listing.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this listing?')">Delete</a>
            </div>
          </div>
        </div>
      </div>
      {% empty %}
        <div class="col-12"><p class="text-muted">No past listings.</p></div>
      {% endfor %}
    </div>

    {% if past_page_obj %}
      {% include 'partials/pagination.html' with page_obj=past_page_obj %}
    {% endif %}
  </div>
</div>
{% endblock %}
