{% extends 'accounts/base.html' %}
{% block title %}Marketplace - Sell - AgriLeader{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">My Product Listings</h2>
    <a href="{% url 'farmer:create_listing' %}" class="btn btn-primary">Create New Listing</a>
</div>

<!-- Revenue Summary - ONLY COMPLETED SALES -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card bg-light">
            <div class="card-body">
                <h5 class="card-title">Completed Sales Revenue</h5>
                <h3 class="text-success">₹{{ totalrevenue|floatformat:2 }}</h3>
                <div class="small text-muted">
                    <div>Completed Bids: ₹{{ totalbidrevenue|floatformat:2 }}</div>
                    <div>Completed Direct Sales: ₹{{ totalregularrevenue|floatformat:2 }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-tabs" id="listingTabs" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" id="ongoing-tab" data-bs-toggle="tab" data-bs-target="#ongoing" type="button">
            Active Bidding
        </button>
    </li>

    <li class="nav-item">
        <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past" type="button">
            Past Listings
        </button>
    </li>
</ul>

<div class="tab-content" id="listingContent">
    <!-- Active Bidding Tab -->
    <div class="tab-pane fade show active" id="ongoing">
        <div class="row">
            {% for listing in ongoinglistings %}
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    {% if listing.image %}
                        <img src="{{ listing.image.url }}" class="card-img-top" alt="{{ listing.name }}" style="height: 200px; object-fit: cover;">
                    {% else %}
                        <img src="https://via.placeholder.com/480x200?text=No+Image" class="card-img-top" alt="No image" style="height: 200px; object-fit: cover;">
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title d-flex justify-content-between align-items-center">
                            <span>{{ listing.name }}</span>
                            <span class="badge bg-success">Active</span>
                        </h5>
                        <p class="card-text mb-2">
                            <strong>Base Price:</strong> ₹{{ listing.price }}<br>
                            <strong>Location:</strong> {{ listing.location }}<br>
                            {% if listing.description %}
                                <strong>Description:</strong> {{ listing.description|truncatewords:20 }}<br>
                            {% endif %}
                        </p>
                        
                        <div class="border-top pt-2 mt-2">
                            <h6>Inventory & Revenue</h6>
                            <div class="small">
                                <div>Available Quantity: {{ listing.availablequantity }}</div>
                            </div>
                            <div class="mt-2">
                                <strong>Completed Payments</strong>
                                <div>Bid Revenue: ₹{{ listing.bidrevenue|floatformat:2 }}</div>
                                <div>Direct Sales: ₹{{ listing.regularsalesrevenue|floatformat:2 }}</div>
                                <div class="fw-bold">Total Revenue: ₹{{ listing.totalrevenue|floatformat:2 }}</div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 mt-3">
                            <a href="{% url 'farmer:edit_listing' listing.id %}" class="btn btn-sm btn-warning">Edit</a>
                            <a href="{% url 'farmer:delete_listing' listing.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this listing?')">Delete</a>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12"><p class="text-muted">No active bidding listings.</p></div>
            {% endfor %}
        </div>
        {% if ongoingpageobj %}{% include 'partials/pagination.html' with pageobj=ongoingpageobj %}{% endif %}
    </div>
    
   
    <!-- Past Listings Tab -->
    <div class="tab-pane fade" id="past">
        <div class="row">
            {% for listing in pastlistings %}
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    {% if listing.image %}
                        <img src="{{ listing.image.url }}" class="card-img-top" alt="{{ listing.name }}" style="height: 200px; object-fit: cover;">
                    {% else %}
                        <img src="https://via.placeholder.com/480x200?text=No+Image" class="card-img-top" alt="No image" style="height: 200px; object-fit: cover;">
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title d-flex justify-content-between align-items-center">
                            <span>{{ listing.name }}</span>
                            <span class="badge bg-secondary">Past</span>
                        </h5>
                        <p class="card-text">
                            <strong>Crop Type:</strong> {{ listing.crop_type }}<br>
                            <strong>Total Stock:</strong> {{ listing.available_quantity }}<br>
                            <strong>Base Price:</strong> ₹{{ listing.price }}<br>
                            <strong>Location:</strong> {{ listing.location }}<br>
                            {% if listing.description %}
                                <strong>Description:</strong> {{ listing.description|truncatewords:20 }}<br>
                            {% endif %}
                            {% with bid=listing.winningbid %}
                            {% if bid %}
                                <strong>Winner:</strong> {{ bid.bidder.username }}<br>
                                <strong>Winning Price:</strong> ₹{{ bid.amount }} × {{ bid.quantity }}<br>
                            {% else %}
                                <strong>No bids received</strong><br>
                            {% endif %}
                            {% endwith %}
                        </p>
                        
                        <div class="border-top pt-2 mt-2">
                            <h6>Final Revenue Summary</h6>
                            <div class="small">
                                <div>Bid Revenue: ₹{{ listing.bid_revenue|floatformat:2 }}</div>
                                <div>Direct Sales: ₹{{ listing.regular_sales_revenue|floatformat:2 }}</div>
                                <div class="fw-bold mt-1">Total: ₹{{ listing.total_revenue|floatformat:2 }}</div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 mt-3">
                            <a href="{% url 'farmer:edit_listing' listing.id %}" class="btn btn-sm btn-warning">Edit</a>
                            <a href="{% url 'farmer:delete_listing' listing.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this listing?')">Delete</a>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12"><p class="text-muted">No past listings.</p></div>
            {% endfor %}
        </div>
        {% if pastpageobj %}{% include 'partials/pagination.html' with pageobj=pastpageobj %}{% endif %}
    </div>
</div>
{% endblock %}
